{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst _ = require(\"lodash\");\n\nconst clc = require(\"cli-color\");\n\nconst marked = require(\"marked\");\n\nconst TerminalRenderer = require(\"marked-terminal\");\n\nconst checkProjectBilling = require(\"./checkProjectBilling\");\n\nconst error_1 = require(\"../error\");\n\nconst logger = require(\"../logger\");\n\nconst rolesHelper = require(\"./rolesHelper\");\n\nconst extensionsApi = require(\"./extensionsApi\");\n\nconst prompt_1 = require(\"../prompt\");\n\nmarked.setOptions({\n  renderer: new TerminalRenderer()\n});\nconst addition = clc.green;\nconst deletion = clc.red;\n\nfunction displayChangesNoInput(spec, newSpec) {\n  const lines = [];\n\n  if (spec.displayName !== newSpec.displayName) {\n    lines.push(\"\", \"**Display Name:**\", deletion(`- ${spec.displayName}`), addition(`+ ${newSpec.displayName}`));\n  }\n\n  if (spec.description !== newSpec.description) {\n    lines.push(\"\", \"**Description:**\", deletion(`- ${spec.description}`), addition(`+ ${newSpec.description}`));\n  }\n\n  if (spec.billingRequired && !newSpec.billingRequired) {\n    lines.push(\"\", \"**Billing is no longer required for this extension.**\");\n  }\n\n  logger.info(marked(lines.join(\"\\n\")));\n  return lines;\n}\n\nexports.displayChangesNoInput = displayChangesNoInput;\n\nfunction displayChangesRequiringConfirmation(spec, newSpec) {\n  return __awaiter(this, void 0, void 0, function* () {\n    if (spec.license !== newSpec.license) {\n      const message = \"\\n\" + \"**License**\\n\" + deletion(spec.license ? `- ${spec.license}\\n` : \"- None\\n\") + addition(newSpec.license ? `+ ${newSpec.license}\\n` : \"+ None\\n\") + \"Do you wish to continue?\";\n      yield getConsent(\"license\", marked(message));\n    }\n\n    const apisDiffDeletions = _.differenceWith(spec.apis, _.get(newSpec, \"apis\", []), _.isEqual);\n\n    const apisDiffAdditions = _.differenceWith(newSpec.apis, _.get(spec, \"apis\", []), _.isEqual);\n\n    if (apisDiffDeletions.length || apisDiffAdditions.length) {\n      let message = \"\\n**APIs:**\\n\";\n      apisDiffDeletions.forEach(api => {\n        message += deletion(`- ${api.apiName} (${api.reason})\\n`);\n      });\n      apisDiffAdditions.forEach(api => {\n        message += addition(`+ ${api.apiName} (${api.reason})\\n`);\n      });\n      message += \"Do you wish to continue?\";\n      yield getConsent(\"apis\", marked(message));\n    }\n\n    const resourcesDiffDeletions = _.differenceWith(spec.resources, _.get(newSpec, \"resources\", []), compareResources);\n\n    const resourcesDiffAdditions = _.differenceWith(newSpec.resources, _.get(spec, \"resources\", []), compareResources);\n\n    if (resourcesDiffDeletions.length || resourcesDiffAdditions.length) {\n      let message = \"\\n**Resources:**\\n\";\n      resourcesDiffDeletions.forEach(resource => {\n        message += deletion(` - ${getResourceReadableName(resource)}`);\n      });\n      resourcesDiffAdditions.forEach(resource => {\n        message += addition(`+ ${getResourceReadableName(resource)}`);\n      });\n      message += \"Do you wish to continue?\";\n      yield getConsent(\"resources\", marked(message));\n    }\n\n    const rolesDiffDeletions = _.differenceWith(spec.roles, _.get(newSpec, \"roles\", []), _.isEqual);\n\n    const rolesDiffAdditions = _.differenceWith(newSpec.roles, _.get(spec, \"roles\", []), _.isEqual);\n\n    if (rolesDiffDeletions.length || rolesDiffAdditions.length) {\n      let message = \"\\n**Permissions:**\\n\";\n      rolesDiffDeletions.forEach(role => {\n        message += deletion(`- ${role.role} (${role.reason})\\n`);\n      });\n      rolesDiffAdditions.forEach(role => {\n        message += addition(`+ ${role.role} (${role.reason})\\n`);\n      });\n      message += \"Do you wish to continue?\";\n      yield getConsent(\"apis\", marked(message));\n    }\n\n    if (!spec.billingRequired && newSpec.billingRequired) {\n      yield getConsent(\"billingRequired\", \"Billing is now required for the new version of this extension. Would you like to continue?\");\n    }\n  });\n}\n\nexports.displayChangesRequiringConfirmation = displayChangesRequiringConfirmation;\n\nfunction compareResources(resource1, resource2) {\n  return resource1.name == resource2.name && resource1.type == resource2.type;\n}\n\nfunction getResourceReadableName(resource) {\n  return resource.type === \"firebaseextensions.v1beta.function\" ? `${resource.name} (Cloud Function): ${resource.description}\\n` : `${resource.name} (${resource.type})\\n`;\n}\n\nfunction getConsent(field, message) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const consent = yield prompt_1.promptOnce({\n      type: \"confirm\",\n      message,\n      default: true\n    });\n\n    if (!consent) {\n      throw new error_1.FirebaseError(`Without explicit consent for the change to ${field}, we cannot update this extension instance.`, {\n        exit: 2\n      });\n    }\n  });\n}\n\nfunction confirmUpdateWarning(updateWarning) {\n  return __awaiter(this, void 0, void 0, function* () {\n    logger.info(marked(updateWarning.description));\n\n    if (updateWarning.action) {\n      logger.info(marked(updateWarning.action));\n    }\n\n    const continueUpdate = yield prompt_1.promptOnce({\n      type: \"confirm\",\n      message: \"Do you wish to continue with this update?\",\n      default: false\n    });\n\n    if (!continueUpdate) {\n      throw new error_1.FirebaseError(`Update cancelled.`, {\n        exit: 2\n      });\n    }\n  });\n}\n\nexports.confirmUpdateWarning = confirmUpdateWarning;\n\nfunction displayChanges(spec, newSpec) {\n  return __awaiter(this, void 0, void 0, function* () {\n    logger.info(\"This update contains the following changes. \" + \"If at any point you choose not to continue, the extension will not be updated and the changes will be discarded:\");\n    displayChangesNoInput(spec, newSpec);\n    yield displayChangesRequiringConfirmation(spec, newSpec);\n  });\n}\n\nexports.displayChanges = displayChanges;\n\nfunction update(updateOptions) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const projectId = updateOptions.projectId,\n          instanceId = updateOptions.instanceId,\n          source = updateOptions.source,\n          params = updateOptions.params,\n          rolesToAdd = updateOptions.rolesToAdd,\n          rolesToRemove = updateOptions.rolesToRemove,\n          serviceAccountEmail = updateOptions.serviceAccountEmail,\n          billingRequired = updateOptions.billingRequired;\n    yield checkProjectBilling(projectId, instanceId, billingRequired);\n    yield rolesHelper.grantRoles(projectId, serviceAccountEmail, rolesToAdd.map(role => role.role), rolesToRemove.map(role => role.role));\n    return yield extensionsApi.updateInstance(projectId, instanceId, source, params);\n  });\n}\n\nexports.update = update;","map":{"version":3,"sources":["/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/firebase-tools/lib/extensions/updateHelper.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","_","require","clc","marked","TerminalRenderer","checkProjectBilling","error_1","logger","rolesHelper","extensionsApi","prompt_1","setOptions","renderer","addition","green","deletion","red","displayChangesNoInput","spec","newSpec","lines","displayName","push","description","billingRequired","info","join","displayChangesRequiringConfirmation","license","message","getConsent","apisDiffDeletions","differenceWith","apis","get","isEqual","apisDiffAdditions","length","forEach","api","apiName","reason","resourcesDiffDeletions","resources","compareResources","resourcesDiffAdditions","resource","getResourceReadableName","rolesDiffDeletions","roles","rolesDiffAdditions","role","resource1","resource2","name","type","field","consent","promptOnce","default","FirebaseError","exit","confirmUpdateWarning","updateWarning","action","continueUpdate","displayChanges","update","updateOptions","projectId","instanceId","source","params","rolesToAdd","rolesToRemove","serviceAccountEmail","grantRoles","map","updateInstance"],"mappings":"AAAA;;AACA,IAAIA,SAAS,GAAI,QAAQ,KAAKA,SAAd,IAA4B,UAAUC,OAAV,EAAmBC,UAAnB,EAA+BC,CAA/B,EAAkCC,SAAlC,EAA6C;AACrF,SAAO,KAAKD,CAAC,KAAKA,CAAC,GAAGE,OAAT,CAAN,EAAyB,UAAUC,OAAV,EAAmBC,MAAnB,EAA2B;AACvD,aAASC,SAAT,CAAmBC,KAAnB,EAA0B;AAAE,UAAI;AAAEC,QAAAA,IAAI,CAACN,SAAS,CAACO,IAAV,CAAeF,KAAf,CAAD,CAAJ;AAA8B,OAApC,CAAqC,OAAOG,CAAP,EAAU;AAAEL,QAAAA,MAAM,CAACK,CAAD,CAAN;AAAY;AAAE;;AAC3F,aAASC,QAAT,CAAkBJ,KAAlB,EAAyB;AAAE,UAAI;AAAEC,QAAAA,IAAI,CAACN,SAAS,CAAC,OAAD,CAAT,CAAmBK,KAAnB,CAAD,CAAJ;AAAkC,OAAxC,CAAyC,OAAOG,CAAP,EAAU;AAAEL,QAAAA,MAAM,CAACK,CAAD,CAAN;AAAY;AAAE;;AAC9F,aAASF,IAAT,CAAcI,MAAd,EAAsB;AAAEA,MAAAA,MAAM,CAACC,IAAP,GAAcT,OAAO,CAACQ,MAAM,CAACL,KAAR,CAArB,GAAsC,IAAIN,CAAJ,CAAM,UAAUG,OAAV,EAAmB;AAAEA,QAAAA,OAAO,CAACQ,MAAM,CAACL,KAAR,CAAP;AAAwB,OAAnD,EAAqDO,IAArD,CAA0DR,SAA1D,EAAqEK,QAArE,CAAtC;AAAuH;;AAC/IH,IAAAA,IAAI,CAAC,CAACN,SAAS,GAAGA,SAAS,CAACa,KAAV,CAAgBhB,OAAhB,EAAyBC,UAAU,IAAI,EAAvC,CAAb,EAAyDS,IAAzD,EAAD,CAAJ;AACH,GALM,CAAP;AAMH,CAPD;;AAQAO,MAAM,CAACC,cAAP,CAAsBC,OAAtB,EAA+B,YAA/B,EAA6C;AAAEX,EAAAA,KAAK,EAAE;AAAT,CAA7C;;AACA,MAAMY,CAAC,GAAGC,OAAO,CAAC,QAAD,CAAjB;;AACA,MAAMC,GAAG,GAAGD,OAAO,CAAC,WAAD,CAAnB;;AACA,MAAME,MAAM,GAAGF,OAAO,CAAC,QAAD,CAAtB;;AACA,MAAMG,gBAAgB,GAAGH,OAAO,CAAC,iBAAD,CAAhC;;AACA,MAAMI,mBAAmB,GAAGJ,OAAO,CAAC,uBAAD,CAAnC;;AACA,MAAMK,OAAO,GAAGL,OAAO,CAAC,UAAD,CAAvB;;AACA,MAAMM,MAAM,GAAGN,OAAO,CAAC,WAAD,CAAtB;;AACA,MAAMO,WAAW,GAAGP,OAAO,CAAC,eAAD,CAA3B;;AACA,MAAMQ,aAAa,GAAGR,OAAO,CAAC,iBAAD,CAA7B;;AACA,MAAMS,QAAQ,GAAGT,OAAO,CAAC,WAAD,CAAxB;;AACAE,MAAM,CAACQ,UAAP,CAAkB;AACdC,EAAAA,QAAQ,EAAE,IAAIR,gBAAJ;AADI,CAAlB;AAGA,MAAMS,QAAQ,GAAGX,GAAG,CAACY,KAArB;AACA,MAAMC,QAAQ,GAAGb,GAAG,CAACc,GAArB;;AACA,SAASC,qBAAT,CAA+BC,IAA/B,EAAqCC,OAArC,EAA8C;AAC1C,QAAMC,KAAK,GAAG,EAAd;;AACA,MAAIF,IAAI,CAACG,WAAL,KAAqBF,OAAO,CAACE,WAAjC,EAA8C;AAC1CD,IAAAA,KAAK,CAACE,IAAN,CAAW,EAAX,EAAe,mBAAf,EAAoCP,QAAQ,CAAE,KAAIG,IAAI,CAACG,WAAY,EAAvB,CAA5C,EAAuER,QAAQ,CAAE,KAAIM,OAAO,CAACE,WAAY,EAA1B,CAA/E;AACH;;AACD,MAAIH,IAAI,CAACK,WAAL,KAAqBJ,OAAO,CAACI,WAAjC,EAA8C;AAC1CH,IAAAA,KAAK,CAACE,IAAN,CAAW,EAAX,EAAe,kBAAf,EAAmCP,QAAQ,CAAE,KAAIG,IAAI,CAACK,WAAY,EAAvB,CAA3C,EAAsEV,QAAQ,CAAE,KAAIM,OAAO,CAACI,WAAY,EAA1B,CAA9E;AACH;;AACD,MAAIL,IAAI,CAACM,eAAL,IAAwB,CAACL,OAAO,CAACK,eAArC,EAAsD;AAClDJ,IAAAA,KAAK,CAACE,IAAN,CAAW,EAAX,EAAe,uDAAf;AACH;;AACDf,EAAAA,MAAM,CAACkB,IAAP,CAAYtB,MAAM,CAACiB,KAAK,CAACM,IAAN,CAAW,IAAX,CAAD,CAAlB;AACA,SAAON,KAAP;AACH;;AACDrB,OAAO,CAACkB,qBAAR,GAAgCA,qBAAhC;;AACA,SAASU,mCAAT,CAA6CT,IAA7C,EAAmDC,OAAnD,EAA4D;AACxD,SAAOxC,SAAS,CAAC,IAAD,EAAO,KAAK,CAAZ,EAAe,KAAK,CAApB,EAAuB,aAAa;AAChD,QAAIuC,IAAI,CAACU,OAAL,KAAiBT,OAAO,CAACS,OAA7B,EAAsC;AAClC,YAAMC,OAAO,GAAG,OACZ,eADY,GAEZd,QAAQ,CAACG,IAAI,CAACU,OAAL,GAAgB,KAAIV,IAAI,CAACU,OAAQ,IAAjC,GAAuC,UAAxC,CAFI,GAGZf,QAAQ,CAACM,OAAO,CAACS,OAAR,GAAmB,KAAIT,OAAO,CAACS,OAAQ,IAAvC,GAA6C,UAA9C,CAHI,GAIZ,0BAJJ;AAKA,YAAME,UAAU,CAAC,SAAD,EAAY3B,MAAM,CAAC0B,OAAD,CAAlB,CAAhB;AACH;;AACD,UAAME,iBAAiB,GAAG/B,CAAC,CAACgC,cAAF,CAAiBd,IAAI,CAACe,IAAtB,EAA4BjC,CAAC,CAACkC,GAAF,CAAMf,OAAN,EAAe,MAAf,EAAuB,EAAvB,CAA5B,EAAwDnB,CAAC,CAACmC,OAA1D,CAA1B;;AACA,UAAMC,iBAAiB,GAAGpC,CAAC,CAACgC,cAAF,CAAiBb,OAAO,CAACc,IAAzB,EAA+BjC,CAAC,CAACkC,GAAF,CAAMhB,IAAN,EAAY,MAAZ,EAAoB,EAApB,CAA/B,EAAwDlB,CAAC,CAACmC,OAA1D,CAA1B;;AACA,QAAIJ,iBAAiB,CAACM,MAAlB,IAA4BD,iBAAiB,CAACC,MAAlD,EAA0D;AACtD,UAAIR,OAAO,GAAG,eAAd;AACAE,MAAAA,iBAAiB,CAACO,OAAlB,CAA2BC,GAAD,IAAS;AAC/BV,QAAAA,OAAO,IAAId,QAAQ,CAAE,KAAIwB,GAAG,CAACC,OAAQ,KAAID,GAAG,CAACE,MAAO,KAAjC,CAAnB;AACH,OAFD;AAGAL,MAAAA,iBAAiB,CAACE,OAAlB,CAA2BC,GAAD,IAAS;AAC/BV,QAAAA,OAAO,IAAIhB,QAAQ,CAAE,KAAI0B,GAAG,CAACC,OAAQ,KAAID,GAAG,CAACE,MAAO,KAAjC,CAAnB;AACH,OAFD;AAGAZ,MAAAA,OAAO,IAAI,0BAAX;AACA,YAAMC,UAAU,CAAC,MAAD,EAAS3B,MAAM,CAAC0B,OAAD,CAAf,CAAhB;AACH;;AACD,UAAMa,sBAAsB,GAAG1C,CAAC,CAACgC,cAAF,CAAiBd,IAAI,CAACyB,SAAtB,EAAiC3C,CAAC,CAACkC,GAAF,CAAMf,OAAN,EAAe,WAAf,EAA4B,EAA5B,CAAjC,EAAkEyB,gBAAlE,CAA/B;;AACA,UAAMC,sBAAsB,GAAG7C,CAAC,CAACgC,cAAF,CAAiBb,OAAO,CAACwB,SAAzB,EAAoC3C,CAAC,CAACkC,GAAF,CAAMhB,IAAN,EAAY,WAAZ,EAAyB,EAAzB,CAApC,EAAkE0B,gBAAlE,CAA/B;;AACA,QAAIF,sBAAsB,CAACL,MAAvB,IAAiCQ,sBAAsB,CAACR,MAA5D,EAAoE;AAChE,UAAIR,OAAO,GAAG,oBAAd;AACAa,MAAAA,sBAAsB,CAACJ,OAAvB,CAAgCQ,QAAD,IAAc;AACzCjB,QAAAA,OAAO,IAAId,QAAQ,CAAE,MAAKgC,uBAAuB,CAACD,QAAD,CAAW,EAAzC,CAAnB;AACH,OAFD;AAGAD,MAAAA,sBAAsB,CAACP,OAAvB,CAAgCQ,QAAD,IAAc;AACzCjB,QAAAA,OAAO,IAAIhB,QAAQ,CAAE,KAAIkC,uBAAuB,CAACD,QAAD,CAAW,EAAxC,CAAnB;AACH,OAFD;AAGAjB,MAAAA,OAAO,IAAI,0BAAX;AACA,YAAMC,UAAU,CAAC,WAAD,EAAc3B,MAAM,CAAC0B,OAAD,CAApB,CAAhB;AACH;;AACD,UAAMmB,kBAAkB,GAAGhD,CAAC,CAACgC,cAAF,CAAiBd,IAAI,CAAC+B,KAAtB,EAA6BjD,CAAC,CAACkC,GAAF,CAAMf,OAAN,EAAe,OAAf,EAAwB,EAAxB,CAA7B,EAA0DnB,CAAC,CAACmC,OAA5D,CAA3B;;AACA,UAAMe,kBAAkB,GAAGlD,CAAC,CAACgC,cAAF,CAAiBb,OAAO,CAAC8B,KAAzB,EAAgCjD,CAAC,CAACkC,GAAF,CAAMhB,IAAN,EAAY,OAAZ,EAAqB,EAArB,CAAhC,EAA0DlB,CAAC,CAACmC,OAA5D,CAA3B;;AACA,QAAIa,kBAAkB,CAACX,MAAnB,IAA6Ba,kBAAkB,CAACb,MAApD,EAA4D;AACxD,UAAIR,OAAO,GAAG,sBAAd;AACAmB,MAAAA,kBAAkB,CAACV,OAAnB,CAA4Ba,IAAD,IAAU;AACjCtB,QAAAA,OAAO,IAAId,QAAQ,CAAE,KAAIoC,IAAI,CAACA,IAAK,KAAIA,IAAI,CAACV,MAAO,KAAhC,CAAnB;AACH,OAFD;AAGAS,MAAAA,kBAAkB,CAACZ,OAAnB,CAA4Ba,IAAD,IAAU;AACjCtB,QAAAA,OAAO,IAAIhB,QAAQ,CAAE,KAAIsC,IAAI,CAACA,IAAK,KAAIA,IAAI,CAACV,MAAO,KAAhC,CAAnB;AACH,OAFD;AAGAZ,MAAAA,OAAO,IAAI,0BAAX;AACA,YAAMC,UAAU,CAAC,MAAD,EAAS3B,MAAM,CAAC0B,OAAD,CAAf,CAAhB;AACH;;AACD,QAAI,CAACX,IAAI,CAACM,eAAN,IAAyBL,OAAO,CAACK,eAArC,EAAsD;AAClD,YAAMM,UAAU,CAAC,iBAAD,EAAoB,4FAApB,CAAhB;AACH;AACJ,GAnDe,CAAhB;AAoDH;;AACD/B,OAAO,CAAC4B,mCAAR,GAA8CA,mCAA9C;;AACA,SAASiB,gBAAT,CAA0BQ,SAA1B,EAAqCC,SAArC,EAAgD;AAC5C,SAAOD,SAAS,CAACE,IAAV,IAAkBD,SAAS,CAACC,IAA5B,IAAoCF,SAAS,CAACG,IAAV,IAAkBF,SAAS,CAACE,IAAvE;AACH;;AACD,SAASR,uBAAT,CAAiCD,QAAjC,EAA2C;AACvC,SAAOA,QAAQ,CAACS,IAAT,KAAkB,oCAAlB,GACA,GAAET,QAAQ,CAACQ,IAAK,sBAAqBR,QAAQ,CAACvB,WAAY,IAD1D,GAEA,GAAEuB,QAAQ,CAACQ,IAAK,KAAIR,QAAQ,CAACS,IAAK,KAFzC;AAGH;;AACD,SAASzB,UAAT,CAAoB0B,KAApB,EAA2B3B,OAA3B,EAAoC;AAChC,SAAOlD,SAAS,CAAC,IAAD,EAAO,KAAK,CAAZ,EAAe,KAAK,CAApB,EAAuB,aAAa;AAChD,UAAM8E,OAAO,GAAG,MAAM/C,QAAQ,CAACgD,UAAT,CAAoB;AACtCH,MAAAA,IAAI,EAAE,SADgC;AAEtC1B,MAAAA,OAFsC;AAGtC8B,MAAAA,OAAO,EAAE;AAH6B,KAApB,CAAtB;;AAKA,QAAI,CAACF,OAAL,EAAc;AACV,YAAM,IAAInD,OAAO,CAACsD,aAAZ,CAA2B,8CAA6CJ,KAAM,6CAA9E,EAA4H;AAAEK,QAAAA,IAAI,EAAE;AAAR,OAA5H,CAAN;AACH;AACJ,GATe,CAAhB;AAUH;;AACD,SAASC,oBAAT,CAA8BC,aAA9B,EAA6C;AACzC,SAAOpF,SAAS,CAAC,IAAD,EAAO,KAAK,CAAZ,EAAe,KAAK,CAApB,EAAuB,aAAa;AAChD4B,IAAAA,MAAM,CAACkB,IAAP,CAAYtB,MAAM,CAAC4D,aAAa,CAACxC,WAAf,CAAlB;;AACA,QAAIwC,aAAa,CAACC,MAAlB,EAA0B;AACtBzD,MAAAA,MAAM,CAACkB,IAAP,CAAYtB,MAAM,CAAC4D,aAAa,CAACC,MAAf,CAAlB;AACH;;AACD,UAAMC,cAAc,GAAG,MAAMvD,QAAQ,CAACgD,UAAT,CAAoB;AAC7CH,MAAAA,IAAI,EAAE,SADuC;AAE7C1B,MAAAA,OAAO,EAAE,2CAFoC;AAG7C8B,MAAAA,OAAO,EAAE;AAHoC,KAApB,CAA7B;;AAKA,QAAI,CAACM,cAAL,EAAqB;AACjB,YAAM,IAAI3D,OAAO,CAACsD,aAAZ,CAA2B,mBAA3B,EAA+C;AAAEC,QAAAA,IAAI,EAAE;AAAR,OAA/C,CAAN;AACH;AACJ,GAbe,CAAhB;AAcH;;AACD9D,OAAO,CAAC+D,oBAAR,GAA+BA,oBAA/B;;AACA,SAASI,cAAT,CAAwBhD,IAAxB,EAA8BC,OAA9B,EAAuC;AACnC,SAAOxC,SAAS,CAAC,IAAD,EAAO,KAAK,CAAZ,EAAe,KAAK,CAApB,EAAuB,aAAa;AAChD4B,IAAAA,MAAM,CAACkB,IAAP,CAAY,iDACR,kHADJ;AAEAR,IAAAA,qBAAqB,CAACC,IAAD,EAAOC,OAAP,CAArB;AACA,UAAMQ,mCAAmC,CAACT,IAAD,EAAOC,OAAP,CAAzC;AACH,GALe,CAAhB;AAMH;;AACDpB,OAAO,CAACmE,cAAR,GAAyBA,cAAzB;;AACA,SAASC,MAAT,CAAgBC,aAAhB,EAA+B;AAC3B,SAAOzF,SAAS,CAAC,IAAD,EAAO,KAAK,CAAZ,EAAe,KAAK,CAApB,EAAuB,aAAa;AAAA,UACxC0F,SADwC,GACoED,aADpE,CACxCC,SADwC;AAAA,UAC7BC,UAD6B,GACoEF,aADpE,CAC7BE,UAD6B;AAAA,UACjBC,MADiB,GACoEH,aADpE,CACjBG,MADiB;AAAA,UACTC,MADS,GACoEJ,aADpE,CACTI,MADS;AAAA,UACDC,UADC,GACoEL,aADpE,CACDK,UADC;AAAA,UACWC,aADX,GACoEN,aADpE,CACWM,aADX;AAAA,UAC0BC,mBAD1B,GACoEP,aADpE,CAC0BO,mBAD1B;AAAA,UAC+CnD,eAD/C,GACoE4C,aADpE,CAC+C5C,eAD/C;AAEhD,UAAMnB,mBAAmB,CAACgE,SAAD,EAAYC,UAAZ,EAAwB9C,eAAxB,CAAzB;AACA,UAAMhB,WAAW,CAACoE,UAAZ,CAAuBP,SAAvB,EAAkCM,mBAAlC,EAAuDF,UAAU,CAACI,GAAX,CAAgB1B,IAAD,IAAUA,IAAI,CAACA,IAA9B,CAAvD,EAA4FuB,aAAa,CAACG,GAAd,CAAmB1B,IAAD,IAAUA,IAAI,CAACA,IAAjC,CAA5F,CAAN;AACA,WAAO,MAAM1C,aAAa,CAACqE,cAAd,CAA6BT,SAA7B,EAAwCC,UAAxC,EAAoDC,MAApD,EAA4DC,MAA5D,CAAb;AACH,GALe,CAAhB;AAMH;;AACDzE,OAAO,CAACoE,MAAR,GAAiBA,MAAjB","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst _ = require(\"lodash\");\nconst clc = require(\"cli-color\");\nconst marked = require(\"marked\");\nconst TerminalRenderer = require(\"marked-terminal\");\nconst checkProjectBilling = require(\"./checkProjectBilling\");\nconst error_1 = require(\"../error\");\nconst logger = require(\"../logger\");\nconst rolesHelper = require(\"./rolesHelper\");\nconst extensionsApi = require(\"./extensionsApi\");\nconst prompt_1 = require(\"../prompt\");\nmarked.setOptions({\n    renderer: new TerminalRenderer(),\n});\nconst addition = clc.green;\nconst deletion = clc.red;\nfunction displayChangesNoInput(spec, newSpec) {\n    const lines = [];\n    if (spec.displayName !== newSpec.displayName) {\n        lines.push(\"\", \"**Display Name:**\", deletion(`- ${spec.displayName}`), addition(`+ ${newSpec.displayName}`));\n    }\n    if (spec.description !== newSpec.description) {\n        lines.push(\"\", \"**Description:**\", deletion(`- ${spec.description}`), addition(`+ ${newSpec.description}`));\n    }\n    if (spec.billingRequired && !newSpec.billingRequired) {\n        lines.push(\"\", \"**Billing is no longer required for this extension.**\");\n    }\n    logger.info(marked(lines.join(\"\\n\")));\n    return lines;\n}\nexports.displayChangesNoInput = displayChangesNoInput;\nfunction displayChangesRequiringConfirmation(spec, newSpec) {\n    return __awaiter(this, void 0, void 0, function* () {\n        if (spec.license !== newSpec.license) {\n            const message = \"\\n\" +\n                \"**License**\\n\" +\n                deletion(spec.license ? `- ${spec.license}\\n` : \"- None\\n\") +\n                addition(newSpec.license ? `+ ${newSpec.license}\\n` : \"+ None\\n\") +\n                \"Do you wish to continue?\";\n            yield getConsent(\"license\", marked(message));\n        }\n        const apisDiffDeletions = _.differenceWith(spec.apis, _.get(newSpec, \"apis\", []), _.isEqual);\n        const apisDiffAdditions = _.differenceWith(newSpec.apis, _.get(spec, \"apis\", []), _.isEqual);\n        if (apisDiffDeletions.length || apisDiffAdditions.length) {\n            let message = \"\\n**APIs:**\\n\";\n            apisDiffDeletions.forEach((api) => {\n                message += deletion(`- ${api.apiName} (${api.reason})\\n`);\n            });\n            apisDiffAdditions.forEach((api) => {\n                message += addition(`+ ${api.apiName} (${api.reason})\\n`);\n            });\n            message += \"Do you wish to continue?\";\n            yield getConsent(\"apis\", marked(message));\n        }\n        const resourcesDiffDeletions = _.differenceWith(spec.resources, _.get(newSpec, \"resources\", []), compareResources);\n        const resourcesDiffAdditions = _.differenceWith(newSpec.resources, _.get(spec, \"resources\", []), compareResources);\n        if (resourcesDiffDeletions.length || resourcesDiffAdditions.length) {\n            let message = \"\\n**Resources:**\\n\";\n            resourcesDiffDeletions.forEach((resource) => {\n                message += deletion(` - ${getResourceReadableName(resource)}`);\n            });\n            resourcesDiffAdditions.forEach((resource) => {\n                message += addition(`+ ${getResourceReadableName(resource)}`);\n            });\n            message += \"Do you wish to continue?\";\n            yield getConsent(\"resources\", marked(message));\n        }\n        const rolesDiffDeletions = _.differenceWith(spec.roles, _.get(newSpec, \"roles\", []), _.isEqual);\n        const rolesDiffAdditions = _.differenceWith(newSpec.roles, _.get(spec, \"roles\", []), _.isEqual);\n        if (rolesDiffDeletions.length || rolesDiffAdditions.length) {\n            let message = \"\\n**Permissions:**\\n\";\n            rolesDiffDeletions.forEach((role) => {\n                message += deletion(`- ${role.role} (${role.reason})\\n`);\n            });\n            rolesDiffAdditions.forEach((role) => {\n                message += addition(`+ ${role.role} (${role.reason})\\n`);\n            });\n            message += \"Do you wish to continue?\";\n            yield getConsent(\"apis\", marked(message));\n        }\n        if (!spec.billingRequired && newSpec.billingRequired) {\n            yield getConsent(\"billingRequired\", \"Billing is now required for the new version of this extension. Would you like to continue?\");\n        }\n    });\n}\nexports.displayChangesRequiringConfirmation = displayChangesRequiringConfirmation;\nfunction compareResources(resource1, resource2) {\n    return resource1.name == resource2.name && resource1.type == resource2.type;\n}\nfunction getResourceReadableName(resource) {\n    return resource.type === \"firebaseextensions.v1beta.function\"\n        ? `${resource.name} (Cloud Function): ${resource.description}\\n`\n        : `${resource.name} (${resource.type})\\n`;\n}\nfunction getConsent(field, message) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const consent = yield prompt_1.promptOnce({\n            type: \"confirm\",\n            message,\n            default: true,\n        });\n        if (!consent) {\n            throw new error_1.FirebaseError(`Without explicit consent for the change to ${field}, we cannot update this extension instance.`, { exit: 2 });\n        }\n    });\n}\nfunction confirmUpdateWarning(updateWarning) {\n    return __awaiter(this, void 0, void 0, function* () {\n        logger.info(marked(updateWarning.description));\n        if (updateWarning.action) {\n            logger.info(marked(updateWarning.action));\n        }\n        const continueUpdate = yield prompt_1.promptOnce({\n            type: \"confirm\",\n            message: \"Do you wish to continue with this update?\",\n            default: false,\n        });\n        if (!continueUpdate) {\n            throw new error_1.FirebaseError(`Update cancelled.`, { exit: 2 });\n        }\n    });\n}\nexports.confirmUpdateWarning = confirmUpdateWarning;\nfunction displayChanges(spec, newSpec) {\n    return __awaiter(this, void 0, void 0, function* () {\n        logger.info(\"This update contains the following changes. \" +\n            \"If at any point you choose not to continue, the extension will not be updated and the changes will be discarded:\");\n        displayChangesNoInput(spec, newSpec);\n        yield displayChangesRequiringConfirmation(spec, newSpec);\n    });\n}\nexports.displayChanges = displayChanges;\nfunction update(updateOptions) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const { projectId, instanceId, source, params, rolesToAdd, rolesToRemove, serviceAccountEmail, billingRequired, } = updateOptions;\n        yield checkProjectBilling(projectId, instanceId, billingRequired);\n        yield rolesHelper.grantRoles(projectId, serviceAccountEmail, rolesToAdd.map((role) => role.role), rolesToRemove.map((role) => role.role));\n        return yield extensionsApi.updateInstance(projectId, instanceId, source, params);\n    });\n}\nexports.update = update;\n"]},"metadata":{},"sourceType":"script"}