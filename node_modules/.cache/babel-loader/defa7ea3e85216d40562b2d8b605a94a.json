{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst _ = require(\"lodash\");\n\nconst logger = require(\"../logger\");\n\nconst parseTriggers = require(\"../parseTriggers\");\n\nconst utils = require(\"../utils\");\n\nconst os = require(\"os\");\n\nconst path = require(\"path\");\n\nconst fs = require(\"fs\");\n\nvar EmulatedTriggerType;\n\n(function (EmulatedTriggerType) {\n  EmulatedTriggerType[\"BACKGROUND\"] = \"BACKGROUND\";\n  EmulatedTriggerType[\"HTTPS\"] = \"HTTPS\";\n})(EmulatedTriggerType = exports.EmulatedTriggerType || (exports.EmulatedTriggerType = {}));\n\nconst memoryLookup = {\n  \"128MB\": 128,\n  \"256MB\": 256,\n  \"512MB\": 512,\n  \"1GB\": 1024,\n  \"2GB\": 2048\n};\n\nclass EmulatedTrigger {\n  constructor(definition, module) {\n    this.definition = definition;\n    this.module = module;\n  }\n\n  get memoryLimitBytes() {\n    return memoryLookup[this.definition.availableMemoryMb || \"128MB\"] * 1024 * 1024;\n  }\n\n  get timeoutMs() {\n    if (typeof this.definition.timeout === \"number\") {\n      return this.definition.timeout * 1000;\n    } else {\n      return parseInt((this.definition.timeout || \"60s\").split(\"s\")[0], 10) * 1000;\n    }\n  }\n\n  getRawFunction() {\n    if (!this.module) {\n      throw new Error(\"EmulatedTrigger has not been provided a module.\");\n    }\n\n    const func = _.get(this.module, this.definition.entryPoint);\n\n    return func.__emulator_func || func;\n  }\n\n}\n\nexports.EmulatedTrigger = EmulatedTrigger;\n\nfunction getTriggersFromDirectory(projectId, functionsDir, firebaseConfig) {\n  return __awaiter(this, void 0, void 0, function* () {\n    let triggerDefinitions;\n\n    try {\n      triggerDefinitions = yield parseTriggers(projectId, functionsDir, {}, JSON.stringify(firebaseConfig));\n    } catch (e) {\n      utils.logWarning(`Failed to load functions source code.`);\n      logger.info(e.message);\n      return {};\n    }\n\n    return getEmulatedTriggersFromDefinitions(triggerDefinitions, functionsDir);\n  });\n}\n\nexports.getTriggersFromDirectory = getTriggersFromDirectory;\n\nfunction getEmulatedTriggersFromDefinitions(definitions, module) {\n  return definitions.reduce((obj, definition) => {\n    obj[definition.name] = new EmulatedTrigger(definition, module);\n    return obj;\n  }, {});\n}\n\nexports.getEmulatedTriggersFromDefinitions = getEmulatedTriggersFromDefinitions;\n\nfunction getTemporarySocketPath(pid, cwd) {\n  if (process.platform === \"win32\") {\n    return path.join(\"\\\\\\\\?\\\\pipe\", cwd, pid.toString());\n  } else {\n    return path.join(os.tmpdir(), `fire_emu_${pid.toString()}.sock`);\n  }\n}\n\nexports.getTemporarySocketPath = getTemporarySocketPath;\n\nfunction getFunctionRegion(def) {\n  if (def.regions && def.regions.length > 0) {\n    return def.regions[0];\n  }\n\n  return \"us-central1\";\n}\n\nexports.getFunctionRegion = getFunctionRegion;\n\nfunction getFunctionService(def) {\n  if (def.eventTrigger) {\n    return def.eventTrigger.service;\n  }\n\n  return \"unknown\";\n}\n\nexports.getFunctionService = getFunctionService;\n\nfunction waitForBody(req) {\n  let data = \"\";\n  return new Promise(resolve => {\n    req.on(\"data\", chunk => {\n      data += chunk;\n    });\n    req.on(\"end\", () => {\n      resolve(data);\n    });\n  });\n}\n\nexports.waitForBody = waitForBody;\n\nfunction findModuleRoot(moduleName, filepath) {\n  const hierarchy = filepath.split(path.sep);\n\n  for (let i = 0; i < hierarchy.length; i++) {\n    try {\n      let chunks = [];\n\n      if (i) {\n        chunks = hierarchy.slice(0, -i);\n      } else {\n        chunks = hierarchy;\n      }\n\n      const packagePath = path.join(chunks.join(path.sep), \"package.json\");\n      const serializedPackage = fs.readFileSync(packagePath).toString();\n\n      if (JSON.parse(serializedPackage).name === moduleName) {\n        return chunks.join(\"/\");\n      }\n\n      break;\n    } catch (err) {}\n  }\n\n  return \"\";\n}\n\nexports.findModuleRoot = findModuleRoot;","map":{"version":3,"sources":["/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/firebase-tools/lib/emulator/functionsEmulatorShared.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","_","require","logger","parseTriggers","utils","os","path","fs","EmulatedTriggerType","memoryLookup","EmulatedTrigger","constructor","definition","module","memoryLimitBytes","availableMemoryMb","timeoutMs","timeout","parseInt","split","getRawFunction","Error","func","get","entryPoint","__emulator_func","getTriggersFromDirectory","projectId","functionsDir","firebaseConfig","triggerDefinitions","JSON","stringify","logWarning","info","message","getEmulatedTriggersFromDefinitions","definitions","reduce","obj","name","getTemporarySocketPath","pid","cwd","process","platform","join","toString","tmpdir","getFunctionRegion","def","regions","length","getFunctionService","eventTrigger","service","waitForBody","req","data","on","chunk","findModuleRoot","moduleName","filepath","hierarchy","sep","i","chunks","slice","packagePath","serializedPackage","readFileSync","parse","err"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst _ = require(\"lodash\");\nconst logger = require(\"../logger\");\nconst parseTriggers = require(\"../parseTriggers\");\nconst utils = require(\"../utils\");\nconst os = require(\"os\");\nconst path = require(\"path\");\nconst fs = require(\"fs\");\nvar EmulatedTriggerType;\n(function (EmulatedTriggerType) {\n    EmulatedTriggerType[\"BACKGROUND\"] = \"BACKGROUND\";\n    EmulatedTriggerType[\"HTTPS\"] = \"HTTPS\";\n})(EmulatedTriggerType = exports.EmulatedTriggerType || (exports.EmulatedTriggerType = {}));\nconst memoryLookup = {\n    \"128MB\": 128,\n    \"256MB\": 256,\n    \"512MB\": 512,\n    \"1GB\": 1024,\n    \"2GB\": 2048,\n};\nclass EmulatedTrigger {\n    constructor(definition, module) {\n        this.definition = definition;\n        this.module = module;\n    }\n    get memoryLimitBytes() {\n        return memoryLookup[this.definition.availableMemoryMb || \"128MB\"] * 1024 * 1024;\n    }\n    get timeoutMs() {\n        if (typeof this.definition.timeout === \"number\") {\n            return this.definition.timeout * 1000;\n        }\n        else {\n            return parseInt((this.definition.timeout || \"60s\").split(\"s\")[0], 10) * 1000;\n        }\n    }\n    getRawFunction() {\n        if (!this.module) {\n            throw new Error(\"EmulatedTrigger has not been provided a module.\");\n        }\n        const func = _.get(this.module, this.definition.entryPoint);\n        return func.__emulator_func || func;\n    }\n}\nexports.EmulatedTrigger = EmulatedTrigger;\nfunction getTriggersFromDirectory(projectId, functionsDir, firebaseConfig) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let triggerDefinitions;\n        try {\n            triggerDefinitions = yield parseTriggers(projectId, functionsDir, {}, JSON.stringify(firebaseConfig));\n        }\n        catch (e) {\n            utils.logWarning(`Failed to load functions source code.`);\n            logger.info(e.message);\n            return {};\n        }\n        return getEmulatedTriggersFromDefinitions(triggerDefinitions, functionsDir);\n    });\n}\nexports.getTriggersFromDirectory = getTriggersFromDirectory;\nfunction getEmulatedTriggersFromDefinitions(definitions, module) {\n    return definitions.reduce((obj, definition) => {\n        obj[definition.name] = new EmulatedTrigger(definition, module);\n        return obj;\n    }, {});\n}\nexports.getEmulatedTriggersFromDefinitions = getEmulatedTriggersFromDefinitions;\nfunction getTemporarySocketPath(pid, cwd) {\n    if (process.platform === \"win32\") {\n        return path.join(\"\\\\\\\\?\\\\pipe\", cwd, pid.toString());\n    }\n    else {\n        return path.join(os.tmpdir(), `fire_emu_${pid.toString()}.sock`);\n    }\n}\nexports.getTemporarySocketPath = getTemporarySocketPath;\nfunction getFunctionRegion(def) {\n    if (def.regions && def.regions.length > 0) {\n        return def.regions[0];\n    }\n    return \"us-central1\";\n}\nexports.getFunctionRegion = getFunctionRegion;\nfunction getFunctionService(def) {\n    if (def.eventTrigger) {\n        return def.eventTrigger.service;\n    }\n    return \"unknown\";\n}\nexports.getFunctionService = getFunctionService;\nfunction waitForBody(req) {\n    let data = \"\";\n    return new Promise((resolve) => {\n        req.on(\"data\", (chunk) => {\n            data += chunk;\n        });\n        req.on(\"end\", () => {\n            resolve(data);\n        });\n    });\n}\nexports.waitForBody = waitForBody;\nfunction findModuleRoot(moduleName, filepath) {\n    const hierarchy = filepath.split(path.sep);\n    for (let i = 0; i < hierarchy.length; i++) {\n        try {\n            let chunks = [];\n            if (i) {\n                chunks = hierarchy.slice(0, -i);\n            }\n            else {\n                chunks = hierarchy;\n            }\n            const packagePath = path.join(chunks.join(path.sep), \"package.json\");\n            const serializedPackage = fs.readFileSync(packagePath).toString();\n            if (JSON.parse(serializedPackage).name === moduleName) {\n                return chunks.join(\"/\");\n            }\n            break;\n        }\n        catch (err) {\n        }\n    }\n    return \"\";\n}\nexports.findModuleRoot = findModuleRoot;\n"]},"metadata":{},"sourceType":"script"}