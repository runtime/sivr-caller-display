{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst lodash_1 = require(\"lodash\");\n\nconst request = require(\"request\");\n\nconst logger = require(\"../logger\");\n\nconst REQUIRED_VARY_VALUES = [\"Accept-Encoding\", \"Authorization\", \"Cookie\"];\n\nfunction makeVary(vary) {\n  if (!vary) {\n    return \"Accept-Encoding, Authorization, Cookie\";\n  }\n\n  const varies = vary.split(/, ?/).map(v => {\n    return v.split(\"-\").map(part => lodash_1.capitalize(part)).join(\"-\");\n  });\n  REQUIRED_VARY_VALUES.forEach(requiredVary => {\n    if (!lodash_1.includes(varies, requiredVary)) {\n      varies.push(requiredVary);\n    }\n  });\n  return varies.join(\", \");\n}\n\nfunction proxyRequestHandler(url, rewriteIdentifier) {\n  return (req, res, next) => {\n    logger.info(`[hosting] Rewriting ${req.url} to ${url} for ${rewriteIdentifier}`);\n    const cookie = req.headers.cookie || \"\";\n    const sessionCookie = cookie.split(/; ?/).find(c => {\n      return c.trim().indexOf(\"__session=\") === 0;\n    });\n    const proxied = request({\n      method: req.method,\n      qs: req.query,\n      url: url + req.url,\n      headers: {\n        \"X-Forwarded-Host\": req.headers.host,\n        \"X-Original-Url\": req.url,\n        Pragma: \"no-cache\",\n        \"Cache-Control\": \"no-cache, no-store\",\n        Cookie: sessionCookie\n      },\n      followRedirect: false,\n      timeout: 60000\n    });\n    req.pipe(proxied);\n    proxied.on(\"error\", err => {\n      if (err.code === \"ETIMEDOUT\" || err.code === \"ESOCKETTIMEDOUT\") {\n        res.statusCode = 504;\n        return res.end(\"Timed out waiting for function to respond.\");\n      }\n\n      res.statusCode = 500;\n      res.end(`An internal error occurred while proxying for ${rewriteIdentifier}`);\n    });\n    proxied.on(\"response\", response => {\n      if (response.statusCode === 404) {\n        const cascade = response.headers[\"x-cascade\"];\n\n        if (cascade && cascade.toUpperCase() === \"PASS\") {\n          return next();\n        }\n      }\n\n      if (!response.headers[\"cache-control\"]) {\n        response.headers[\"cache-control\"] = \"private\";\n      }\n\n      if (response.headers[\"cache-control\"].indexOf(\"private\") < 0) {\n        delete response.headers[\"set-cookie\"];\n      }\n\n      response.headers.vary = makeVary(response.headers.vary);\n      proxied.pipe(res);\n    });\n  };\n}\n\nexports.proxyRequestHandler = proxyRequestHandler;\n\nfunction errorRequestHandler(error) {\n  return (req, res, next) => {\n    res.statusCode = 500;\n    const out = `A problem occurred while trying to handle a proxied rewrite: ${error}`;\n    logger.error(out);\n    res.end(out);\n  };\n}\n\nexports.errorRequestHandler = errorRequestHandler;","map":{"version":3,"sources":["/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/firebase-tools/lib/hosting/proxy.js"],"names":["Object","defineProperty","exports","value","lodash_1","require","request","logger","REQUIRED_VARY_VALUES","makeVary","vary","varies","split","map","v","part","capitalize","join","forEach","requiredVary","includes","push","proxyRequestHandler","url","rewriteIdentifier","req","res","next","info","cookie","headers","sessionCookie","find","c","trim","indexOf","proxied","method","qs","query","host","Pragma","Cookie","followRedirect","timeout","pipe","on","err","code","statusCode","end","response","cascade","toUpperCase","errorRequestHandler","error","out"],"mappings":"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","sourcesContent":["\"use strict\";\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst lodash_1 = require(\"lodash\");\nconst request = require(\"request\");\nconst logger = require(\"../logger\");\nconst REQUIRED_VARY_VALUES = [\"Accept-Encoding\", \"Authorization\", \"Cookie\"];\nfunction makeVary(vary) {\n    if (!vary) {\n        return \"Accept-Encoding, Authorization, Cookie\";\n    }\n    const varies = vary.split(/, ?/).map((v) => {\n        return v\n            .split(\"-\")\n            .map((part) => lodash_1.capitalize(part))\n            .join(\"-\");\n    });\n    REQUIRED_VARY_VALUES.forEach((requiredVary) => {\n        if (!lodash_1.includes(varies, requiredVary)) {\n            varies.push(requiredVary);\n        }\n    });\n    return varies.join(\", \");\n}\nfunction proxyRequestHandler(url, rewriteIdentifier) {\n    return (req, res, next) => {\n        logger.info(`[hosting] Rewriting ${req.url} to ${url} for ${rewriteIdentifier}`);\n        const cookie = req.headers.cookie || \"\";\n        const sessionCookie = cookie.split(/; ?/).find((c) => {\n            return c.trim().indexOf(\"__session=\") === 0;\n        });\n        const proxied = request({\n            method: req.method,\n            qs: req.query,\n            url: url + req.url,\n            headers: {\n                \"X-Forwarded-Host\": req.headers.host,\n                \"X-Original-Url\": req.url,\n                Pragma: \"no-cache\",\n                \"Cache-Control\": \"no-cache, no-store\",\n                Cookie: sessionCookie,\n            },\n            followRedirect: false,\n            timeout: 60000,\n        });\n        req.pipe(proxied);\n        proxied.on(\"error\", (err) => {\n            if (err.code === \"ETIMEDOUT\" || err.code === \"ESOCKETTIMEDOUT\") {\n                res.statusCode = 504;\n                return res.end(\"Timed out waiting for function to respond.\");\n            }\n            res.statusCode = 500;\n            res.end(`An internal error occurred while proxying for ${rewriteIdentifier}`);\n        });\n        proxied.on(\"response\", (response) => {\n            if (response.statusCode === 404) {\n                const cascade = response.headers[\"x-cascade\"];\n                if (cascade && cascade.toUpperCase() === \"PASS\") {\n                    return next();\n                }\n            }\n            if (!response.headers[\"cache-control\"]) {\n                response.headers[\"cache-control\"] = \"private\";\n            }\n            if (response.headers[\"cache-control\"].indexOf(\"private\") < 0) {\n                delete response.headers[\"set-cookie\"];\n            }\n            response.headers.vary = makeVary(response.headers.vary);\n            proxied.pipe(res);\n        });\n    };\n}\nexports.proxyRequestHandler = proxyRequestHandler;\nfunction errorRequestHandler(error) {\n    return (req, res, next) => {\n        res.statusCode = 500;\n        const out = `A problem occurred while trying to handle a proxied rewrite: ${error}`;\n        logger.error(out);\n        res.end(out);\n    };\n}\nexports.errorRequestHandler = errorRequestHandler;\n"]},"metadata":{},"sourceType":"script"}