{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst _ = require(\"lodash\");\n\nconst api = require(\"../api\");\n\nconst logger = require(\"../logger\");\n\nconst utils = require(\"../utils\");\n\nconst API_VERSION = \"v1\";\n\nfunction _handleErrorResponse(response) {\n  if (response.body && response.body.error) {\n    return utils.reject(response.body.error, {\n      code: 2\n    });\n  }\n\n  logger.debug(\"[rules] error:\", response.status, response.body);\n  return utils.reject(\"Unexpected error encountered with rules.\", {\n    code: 2\n  });\n}\n\nfunction getLatestRulesetName(projectId, service) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const releases = yield listAllReleases(projectId);\n    const prefix = `projects/${projectId}/releases/${service}`;\n\n    const release = _.find(releases, r => r.name.indexOf(prefix) === 0);\n\n    if (!release) {\n      return null;\n    }\n\n    return release.rulesetName;\n  });\n}\n\nexports.getLatestRulesetName = getLatestRulesetName;\nconst MAX_RELEASES_PAGE_SIZE = 10;\n\nfunction listReleases(projectId, pageToken) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const response = yield api.request(\"GET\", `/${API_VERSION}/projects/${projectId}/releases`, {\n      auth: true,\n      origin: api.rulesOrigin,\n      query: {\n        pageSize: MAX_RELEASES_PAGE_SIZE,\n        pageToken\n      }\n    });\n\n    if (response.status === 200) {\n      return response.body;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.listReleases = listReleases;\n\nfunction listAllReleases(projectId) {\n  return __awaiter(this, void 0, void 0, function* () {\n    let pageToken;\n    let releases = [];\n\n    do {\n      const response = yield listReleases(projectId, pageToken);\n\n      if (response.releases && response.releases.length > 0) {\n        releases = releases.concat(response.releases);\n      }\n\n      pageToken = response.nextPageToken;\n    } while (pageToken);\n\n    return _.orderBy(releases, [\"createTime\"], [\"desc\"]);\n  });\n}\n\nexports.listAllReleases = listAllReleases;\n\nfunction getRulesetContent(name) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const response = yield api.request(\"GET\", `/${API_VERSION}/${name}`, {\n      auth: true,\n      origin: api.rulesOrigin\n    });\n\n    if (response.status === 200) {\n      const source = response.body.source;\n      return source.files;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.getRulesetContent = getRulesetContent;\nconst MAX_RULESET_PAGE_SIZE = 100;\n\nfunction listRulesets(projectId, pageToken) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const response = yield api.request(\"GET\", `/${API_VERSION}/projects/${projectId}/rulesets`, {\n      auth: true,\n      origin: api.rulesOrigin,\n      query: {\n        pageSize: MAX_RULESET_PAGE_SIZE,\n        pageToken\n      }\n    });\n\n    if (response.status === 200) {\n      return response.body;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.listRulesets = listRulesets;\n\nfunction listAllRulesets(projectId) {\n  return __awaiter(this, void 0, void 0, function* () {\n    let pageToken;\n    let rulesets = [];\n\n    do {\n      const response = yield listRulesets(projectId, pageToken);\n\n      if (response.rulesets) {\n        rulesets = rulesets.concat(response.rulesets);\n      }\n\n      pageToken = response.nextPageToken;\n    } while (pageToken);\n\n    return _.orderBy(rulesets, [\"createTime\"], [\"desc\"]);\n  });\n}\n\nexports.listAllRulesets = listAllRulesets;\n\nfunction getRulesetId(ruleset) {\n  return ruleset.name.split(\"/\").pop();\n}\n\nexports.getRulesetId = getRulesetId;\n\nfunction deleteRuleset(projectId, id) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const response = yield api.request(\"DELETE\", `/${API_VERSION}/projects/${projectId}/rulesets/${id}`, {\n      auth: true,\n      origin: api.rulesOrigin\n    });\n\n    if (response.status === 200) {\n      return;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.deleteRuleset = deleteRuleset;\n\nfunction createRuleset(projectId, files) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const payload = {\n      source: {\n        files\n      }\n    };\n    const response = yield api.request(\"POST\", `/${API_VERSION}/projects/${projectId}/rulesets`, {\n      auth: true,\n      data: payload,\n      origin: api.rulesOrigin\n    });\n\n    if (response.status === 200) {\n      logger.debug(\"[rules] created ruleset\", response.body.name);\n      return response.body.name;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.createRuleset = createRuleset;\n\nfunction createRelease(projectId, rulesetName, releaseName) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const payload = {\n      name: `projects/${projectId}/releases/${releaseName}`,\n      rulesetName\n    };\n    const response = yield api.request(\"POST\", `/${API_VERSION}/projects/${projectId}/releases`, {\n      auth: true,\n      data: payload,\n      origin: api.rulesOrigin\n    });\n\n    if (response.status === 200) {\n      logger.debug(\"[rules] created release\", response.body.name);\n      return response.body.name;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.createRelease = createRelease;\n\nfunction updateRelease(projectId, rulesetName, releaseName) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const payload = {\n      release: {\n        name: `projects/${projectId}/releases/${releaseName}`,\n        rulesetName\n      }\n    };\n    const response = yield api.request(\"PATCH\", `/${API_VERSION}/projects/${projectId}/releases/${releaseName}`, {\n      auth: true,\n      data: payload,\n      origin: api.rulesOrigin\n    });\n\n    if (response.status === 200) {\n      logger.debug(\"[rules] updated release\", response.body.name);\n      return response.body.name;\n    }\n\n    return _handleErrorResponse(response);\n  });\n}\n\nexports.updateRelease = updateRelease;\n\nfunction updateOrCreateRelease(projectId, rulesetName, releaseName) {\n  return __awaiter(this, void 0, void 0, function* () {\n    logger.debug(\"[rules] releasing\", releaseName, \"with ruleset\", rulesetName);\n    return updateRelease(projectId, rulesetName, releaseName).catch(() => {\n      logger.debug(\"[rules] ruleset update failed, attempting to create instead\");\n      return createRelease(projectId, rulesetName, releaseName);\n    });\n  });\n}\n\nexports.updateOrCreateRelease = updateOrCreateRelease;\n\nfunction testRuleset(projectId, files) {\n  return api.request(\"POST\", `/${API_VERSION}/projects/${encodeURIComponent(projectId)}:test`, {\n    origin: api.rulesOrigin,\n    data: {\n      source: {\n        files\n      }\n    },\n    auth: true\n  });\n}\n\nexports.testRuleset = testRuleset;","map":{"version":3,"sources":["/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/firebase-tools/lib/gcp/rules.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","_","require","api","logger","utils","API_VERSION","_handleErrorResponse","response","body","error","code","debug","status","getLatestRulesetName","projectId","service","releases","listAllReleases","prefix","release","find","r","name","indexOf","rulesetName","MAX_RELEASES_PAGE_SIZE","listReleases","pageToken","request","auth","origin","rulesOrigin","query","pageSize","length","concat","nextPageToken","orderBy","getRulesetContent","source","files","MAX_RULESET_PAGE_SIZE","listRulesets","listAllRulesets","rulesets","getRulesetId","ruleset","split","pop","deleteRuleset","id","createRuleset","payload","data","createRelease","releaseName","updateRelease","updateOrCreateRelease","catch","testRuleset","encodeURIComponent"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst _ = require(\"lodash\");\nconst api = require(\"../api\");\nconst logger = require(\"../logger\");\nconst utils = require(\"../utils\");\nconst API_VERSION = \"v1\";\nfunction _handleErrorResponse(response) {\n    if (response.body && response.body.error) {\n        return utils.reject(response.body.error, { code: 2 });\n    }\n    logger.debug(\"[rules] error:\", response.status, response.body);\n    return utils.reject(\"Unexpected error encountered with rules.\", {\n        code: 2,\n    });\n}\nfunction getLatestRulesetName(projectId, service) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const releases = yield listAllReleases(projectId);\n        const prefix = `projects/${projectId}/releases/${service}`;\n        const release = _.find(releases, (r) => r.name.indexOf(prefix) === 0);\n        if (!release) {\n            return null;\n        }\n        return release.rulesetName;\n    });\n}\nexports.getLatestRulesetName = getLatestRulesetName;\nconst MAX_RELEASES_PAGE_SIZE = 10;\nfunction listReleases(projectId, pageToken) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const response = yield api.request(\"GET\", `/${API_VERSION}/projects/${projectId}/releases`, {\n            auth: true,\n            origin: api.rulesOrigin,\n            query: {\n                pageSize: MAX_RELEASES_PAGE_SIZE,\n                pageToken,\n            },\n        });\n        if (response.status === 200) {\n            return response.body;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.listReleases = listReleases;\nfunction listAllReleases(projectId) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let pageToken;\n        let releases = [];\n        do {\n            const response = yield listReleases(projectId, pageToken);\n            if (response.releases && response.releases.length > 0) {\n                releases = releases.concat(response.releases);\n            }\n            pageToken = response.nextPageToken;\n        } while (pageToken);\n        return _.orderBy(releases, [\"createTime\"], [\"desc\"]);\n    });\n}\nexports.listAllReleases = listAllReleases;\nfunction getRulesetContent(name) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const response = yield api.request(\"GET\", `/${API_VERSION}/${name}`, {\n            auth: true,\n            origin: api.rulesOrigin,\n        });\n        if (response.status === 200) {\n            const source = response.body.source;\n            return source.files;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.getRulesetContent = getRulesetContent;\nconst MAX_RULESET_PAGE_SIZE = 100;\nfunction listRulesets(projectId, pageToken) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const response = yield api.request(\"GET\", `/${API_VERSION}/projects/${projectId}/rulesets`, {\n            auth: true,\n            origin: api.rulesOrigin,\n            query: {\n                pageSize: MAX_RULESET_PAGE_SIZE,\n                pageToken,\n            },\n        });\n        if (response.status === 200) {\n            return response.body;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.listRulesets = listRulesets;\nfunction listAllRulesets(projectId) {\n    return __awaiter(this, void 0, void 0, function* () {\n        let pageToken;\n        let rulesets = [];\n        do {\n            const response = yield listRulesets(projectId, pageToken);\n            if (response.rulesets) {\n                rulesets = rulesets.concat(response.rulesets);\n            }\n            pageToken = response.nextPageToken;\n        } while (pageToken);\n        return _.orderBy(rulesets, [\"createTime\"], [\"desc\"]);\n    });\n}\nexports.listAllRulesets = listAllRulesets;\nfunction getRulesetId(ruleset) {\n    return ruleset.name.split(\"/\").pop();\n}\nexports.getRulesetId = getRulesetId;\nfunction deleteRuleset(projectId, id) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const response = yield api.request(\"DELETE\", `/${API_VERSION}/projects/${projectId}/rulesets/${id}`, {\n            auth: true,\n            origin: api.rulesOrigin,\n        });\n        if (response.status === 200) {\n            return;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.deleteRuleset = deleteRuleset;\nfunction createRuleset(projectId, files) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const payload = { source: { files } };\n        const response = yield api.request(\"POST\", `/${API_VERSION}/projects/${projectId}/rulesets`, {\n            auth: true,\n            data: payload,\n            origin: api.rulesOrigin,\n        });\n        if (response.status === 200) {\n            logger.debug(\"[rules] created ruleset\", response.body.name);\n            return response.body.name;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.createRuleset = createRuleset;\nfunction createRelease(projectId, rulesetName, releaseName) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const payload = {\n            name: `projects/${projectId}/releases/${releaseName}`,\n            rulesetName,\n        };\n        const response = yield api.request(\"POST\", `/${API_VERSION}/projects/${projectId}/releases`, {\n            auth: true,\n            data: payload,\n            origin: api.rulesOrigin,\n        });\n        if (response.status === 200) {\n            logger.debug(\"[rules] created release\", response.body.name);\n            return response.body.name;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.createRelease = createRelease;\nfunction updateRelease(projectId, rulesetName, releaseName) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const payload = {\n            release: {\n                name: `projects/${projectId}/releases/${releaseName}`,\n                rulesetName,\n            },\n        };\n        const response = yield api.request(\"PATCH\", `/${API_VERSION}/projects/${projectId}/releases/${releaseName}`, {\n            auth: true,\n            data: payload,\n            origin: api.rulesOrigin,\n        });\n        if (response.status === 200) {\n            logger.debug(\"[rules] updated release\", response.body.name);\n            return response.body.name;\n        }\n        return _handleErrorResponse(response);\n    });\n}\nexports.updateRelease = updateRelease;\nfunction updateOrCreateRelease(projectId, rulesetName, releaseName) {\n    return __awaiter(this, void 0, void 0, function* () {\n        logger.debug(\"[rules] releasing\", releaseName, \"with ruleset\", rulesetName);\n        return updateRelease(projectId, rulesetName, releaseName).catch(() => {\n            logger.debug(\"[rules] ruleset update failed, attempting to create instead\");\n            return createRelease(projectId, rulesetName, releaseName);\n        });\n    });\n}\nexports.updateOrCreateRelease = updateOrCreateRelease;\nfunction testRuleset(projectId, files) {\n    return api.request(\"POST\", `/${API_VERSION}/projects/${encodeURIComponent(projectId)}:test`, {\n        origin: api.rulesOrigin,\n        data: {\n            source: { files },\n        },\n        auth: true,\n    });\n}\nexports.testRuleset = testRuleset;\n"]},"metadata":{},"sourceType":"script"}