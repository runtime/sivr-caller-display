{"ast":null,"code":"\"use strict\";\n\nvar _slicedToArray = require(\"/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/@babel/runtime/helpers/slicedToArray\");\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst _ = require(\"lodash\");\n\nconst ensureApiEnabled_1 = require(\"../../ensureApiEnabled\");\n\nconst functionsDeployHelper_1 = require(\"../../functionsDeployHelper\");\n\nconst cloudscheduler_1 = require(\"../../gcp/cloudscheduler\");\n\nconst pubsub_1 = require(\"../../gcp/pubsub\");\n\nfunction createOrUpdateSchedulesAndTopics(projectId, triggers, existingScheduledFunctions, appEngineLocation) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const triggersWithSchedules = triggers.filter(t => !!t.schedule);\n    let schedulerEnabled = false;\n\n    if (triggersWithSchedules.length) {\n      yield Promise.all([ensureApiEnabled_1.ensure(projectId, \"cloudscheduler.googleapis.com\", \"scheduler\", false), ensureApiEnabled_1.ensure(projectId, \"pubsub.googleapis.com\", \"pubsub\", false)]);\n      schedulerEnabled = true;\n    } else {\n      schedulerEnabled = yield ensureApiEnabled_1.check(projectId, \"cloudscheduler.googleapis.com\", \"scheduler\", false);\n    }\n\n    for (const trigger of triggers) {\n      const _trigger$name$split = trigger.name.split(\"/\"),\n            _trigger$name$split2 = _slicedToArray(_trigger$name$split, 6),\n            region = _trigger$name$split2[3],\n            functionName = _trigger$name$split2[5];\n\n      const scheduleName = functionsDeployHelper_1.getScheduleName(trigger.name, appEngineLocation);\n      const topicName = functionsDeployHelper_1.getTopicName(trigger.name);\n\n      if (!trigger.schedule) {\n        if (schedulerEnabled && _.includes(existingScheduledFunctions, trigger.name)) {\n          try {\n            yield cloudscheduler_1.deleteJob(scheduleName);\n          } catch (err) {\n            if (err.context.response.statusCode !== 404) {\n              throw err;\n            }\n          }\n\n          try {\n            yield pubsub_1.deleteTopic(topicName);\n          } catch (err) {\n            if (err.context.response.statusCode !== 404) {\n              throw err;\n            }\n          }\n        }\n      } else {\n        yield cloudscheduler_1.createOrReplaceJob(Object.assign(trigger.schedule, {\n          name: `projects/${projectId}/locations/${appEngineLocation}/jobs/firebase-schedule-${functionName}-${region}`,\n          pubsubTarget: {\n            topicName: `projects/${projectId}/topics/firebase-schedule-${functionName}-${region}`,\n            attributes: {\n              scheduled: \"true\"\n            }\n          }\n        }));\n      }\n    }\n\n    return;\n  });\n}\n\nexports.createOrUpdateSchedulesAndTopics = createOrUpdateSchedulesAndTopics;","map":{"version":3,"sources":["/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/firebase-tools/lib/deploy/functions/createOrUpdateSchedulesAndTopics.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","_","require","ensureApiEnabled_1","functionsDeployHelper_1","cloudscheduler_1","pubsub_1","createOrUpdateSchedulesAndTopics","projectId","triggers","existingScheduledFunctions","appEngineLocation","triggersWithSchedules","filter","t","schedule","schedulerEnabled","length","all","ensure","check","trigger","name","split","region","functionName","scheduleName","getScheduleName","topicName","getTopicName","includes","deleteJob","err","context","response","statusCode","deleteTopic","createOrReplaceJob","assign","pubsubTarget","attributes","scheduled"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst _ = require(\"lodash\");\nconst ensureApiEnabled_1 = require(\"../../ensureApiEnabled\");\nconst functionsDeployHelper_1 = require(\"../../functionsDeployHelper\");\nconst cloudscheduler_1 = require(\"../../gcp/cloudscheduler\");\nconst pubsub_1 = require(\"../../gcp/pubsub\");\nfunction createOrUpdateSchedulesAndTopics(projectId, triggers, existingScheduledFunctions, appEngineLocation) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const triggersWithSchedules = triggers.filter((t) => !!t.schedule);\n        let schedulerEnabled = false;\n        if (triggersWithSchedules.length) {\n            yield Promise.all([\n                ensureApiEnabled_1.ensure(projectId, \"cloudscheduler.googleapis.com\", \"scheduler\", false),\n                ensureApiEnabled_1.ensure(projectId, \"pubsub.googleapis.com\", \"pubsub\", false),\n            ]);\n            schedulerEnabled = true;\n        }\n        else {\n            schedulerEnabled = yield ensureApiEnabled_1.check(projectId, \"cloudscheduler.googleapis.com\", \"scheduler\", false);\n        }\n        for (const trigger of triggers) {\n            const [, , , region, , functionName] = trigger.name.split(\"/\");\n            const scheduleName = functionsDeployHelper_1.getScheduleName(trigger.name, appEngineLocation);\n            const topicName = functionsDeployHelper_1.getTopicName(trigger.name);\n            if (!trigger.schedule) {\n                if (schedulerEnabled && _.includes(existingScheduledFunctions, trigger.name)) {\n                    try {\n                        yield cloudscheduler_1.deleteJob(scheduleName);\n                    }\n                    catch (err) {\n                        if (err.context.response.statusCode !== 404) {\n                            throw err;\n                        }\n                    }\n                    try {\n                        yield pubsub_1.deleteTopic(topicName);\n                    }\n                    catch (err) {\n                        if (err.context.response.statusCode !== 404) {\n                            throw err;\n                        }\n                    }\n                }\n            }\n            else {\n                yield cloudscheduler_1.createOrReplaceJob(Object.assign(trigger.schedule, {\n                    name: `projects/${projectId}/locations/${appEngineLocation}/jobs/firebase-schedule-${functionName}-${region}`,\n                    pubsubTarget: {\n                        topicName: `projects/${projectId}/topics/firebase-schedule-${functionName}-${region}`,\n                        attributes: {\n                            scheduled: \"true\",\n                        },\n                    },\n                }));\n            }\n        }\n        return;\n    });\n}\nexports.createOrUpdateSchedulesAndTopics = createOrUpdateSchedulesAndTopics;\n"]},"metadata":{},"sourceType":"script"}