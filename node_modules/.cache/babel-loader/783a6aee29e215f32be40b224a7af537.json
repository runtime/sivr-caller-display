{"ast":null,"code":"\"use strict\";\n\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n\n    function step(result) {\n      result.done ? resolve(result.value) : new P(function (resolve) {\n        resolve(result.value);\n      }).then(fulfilled, rejected);\n    }\n\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\n\nconst _ = require(\"lodash\");\n\nconst clc = require(\"cli-color\");\n\nconst api = require(\"../api\");\n\nconst _require = require(\"../error\"),\n      FirebaseError = _require.FirebaseError;\n\nconst logger = require(\"../logger\");\n\nconst utils = require(\"../utils\");\n\nconst API_VERSION = \"v1\";\n\nfunction _functionsOpLogReject(func, type, err) {\n  utils.logWarning(clc.bold.yellow(\"functions:\") + \" failed to \" + type + \" function \" + func);\n\n  if (err.context.response.statusCode === 429) {\n    logger.debug(err.message);\n    logger.info(\"You have exceeded your deployment quota, please deploy your functions in batches by using the --only flag, \" + \"and wait a few minutes before deploying again. Go to https://firebase.google.com/docs/cli/#partial_deploys to learn more.\");\n  } else {\n    logger.info(err.message);\n  }\n\n  return Promise.reject(new FirebaseError(`Failed to ${type} function ${func}`, {\n    original: err,\n    context: {\n      function: func\n    }\n  }));\n}\n\nfunction _generateUploadUrl(projectId, location) {\n  var parent = \"projects/\" + projectId + \"/locations/\" + location;\n  var endpoint = \"/\" + API_VERSION + \"/\" + parent + \"/functions:generateUploadUrl\";\n  return api.request(\"POST\", endpoint, {\n    auth: true,\n    json: false,\n    origin: api.functionsOrigin,\n    retryCodes: [503]\n  }).then(function (result) {\n    var responseBody = JSON.parse(result.body);\n    return Promise.resolve(responseBody.uploadUrl);\n  }, function (err) {\n    logger.info(\"\\n\\nThere was an issue deploying your functions. Verify that your project has a Google App Engine instance setup at https://console.cloud.google.com/appengine and try again. If this issue persists, please contact support.\");\n    return Promise.reject(err);\n  });\n}\n\nfunction _createFunction(options) {\n  var location = \"projects/\" + options.projectId + \"/locations/\" + options.region;\n  var func = location + \"/functions/\" + options.functionName;\n  var endpoint = \"/\" + API_VERSION + \"/\" + location + \"/functions\";\n  var data = {\n    sourceUploadUrl: options.sourceUploadUrl,\n    name: func,\n    entryPoint: options.entryPoint,\n    labels: options.labels,\n    runtime: options.runtime\n  };\n\n  if (options.availableMemoryMb) {\n    data.availableMemoryMb = options.availableMemoryMb;\n  }\n\n  if (options.timeout) {\n    data.timeout = options.timeout;\n  }\n\n  return api.request(\"POST\", endpoint, {\n    auth: true,\n    data: _.assign(data, options.trigger),\n    origin: api.functionsOrigin\n  }).then(function (resp) {\n    return Promise.resolve({\n      func: func,\n      eventType: options.eventType,\n      done: false,\n      name: resp.body.name,\n      type: \"create\"\n    });\n  }, function (err) {\n    return _functionsOpLogReject(options.functionName, \"create\", err);\n  });\n}\n\nfunction _setIamPolicy(options) {\n  return __awaiter(this, void 0, void 0, function* () {\n    const name = `projects/${options.projectId}/locations/${options.region}/functions/${options.functionName}`;\n    const endpoint = `/${API_VERSION}/${name}:setIamPolicy`;\n\n    try {\n      yield api.request(\"POST\", endpoint, {\n        auth: true,\n        data: {\n          policy: options.policy,\n          updateMask: Object.keys(options.policy).join(\",\")\n        },\n        origin: api.functionsOrigin\n      });\n    } catch (err) {\n      throw new FirebaseError(`Failed to set the IAM Policy on the function ${options.functionName}`, {\n        original: err\n      });\n    }\n  });\n}\n\nfunction _updateFunction(options) {\n  var location = \"projects/\" + options.projectId + \"/locations/\" + options.region;\n  var func = location + \"/functions/\" + options.functionName;\n  var endpoint = \"/\" + API_VERSION + \"/\" + func;\n\n  var data = _.assign({\n    sourceUploadUrl: options.sourceUploadUrl,\n    name: func,\n    labels: options.labels\n  }, options.trigger);\n\n  var masks = [\"sourceUploadUrl\", \"name\", \"labels\"];\n\n  if (options.runtime) {\n    data.runtime = options.runtime;\n    masks = _.concat(masks, \"runtime\");\n  }\n\n  if (options.availableMemoryMb) {\n    data.availableMemoryMb = options.availableMemoryMb;\n    masks.push(\"availableMemoryMb\");\n  }\n\n  if (options.timeout) {\n    data.timeout = options.timeout;\n    masks.push(\"timeout\");\n  }\n\n  if (options.trigger.eventTrigger) {\n    masks = _.concat(masks, _.map(_.keys(options.trigger.eventTrigger), function (subkey) {\n      return \"eventTrigger.\" + subkey;\n    }));\n  } else {\n    masks = _.concat(masks, \"httpsTrigger\");\n  }\n\n  return api.request(\"PATCH\", endpoint, {\n    qs: {\n      updateMask: masks.join(\",\")\n    },\n    auth: true,\n    data: data,\n    origin: api.functionsOrigin\n  }).then(function (resp) {\n    return Promise.resolve({\n      func: func,\n      done: false,\n      name: resp.body.name,\n      type: \"update\"\n    });\n  }, function (err) {\n    return _functionsOpLogReject(options.functionName, \"update\", err);\n  });\n}\n\nfunction _deleteFunction(options) {\n  var location = \"projects/\" + options.projectId + \"/locations/\" + options.region;\n  var func = location + \"/functions/\" + options.functionName;\n  var endpoint = \"/\" + API_VERSION + \"/\" + func;\n  return api.request(\"DELETE\", endpoint, {\n    auth: true,\n    origin: api.functionsOrigin\n  }).then(function (resp) {\n    return Promise.resolve({\n      func: func,\n      done: false,\n      name: resp.body.name,\n      type: \"delete\"\n    });\n  }, function (err) {\n    return _functionsOpLogReject(options.functionName, \"delete\", err);\n  });\n}\n\nfunction _listFunctions(projectId, region) {\n  var endpoint = \"/\" + API_VERSION + \"/projects/\" + projectId + \"/locations/\" + region + \"/functions\";\n  return api.request(\"GET\", endpoint, {\n    auth: true,\n    origin: api.functionsOrigin\n  }).then(function (resp) {\n    if (resp.body.unreachable && resp.body.unreachable.length > 0) {\n      return utils.reject(\"Some Cloud Functions regions were unreachable, please try again later.\", {\n        exit: 2\n      });\n    }\n\n    var functionsList = resp.body.functions || [];\n\n    _.forEach(functionsList, function (f) {\n      f.functionName = f.name.substring(f.name.lastIndexOf(\"/\") + 1);\n    });\n\n    return Promise.resolve(functionsList);\n  }, function (err) {\n    logger.debug(\"[functions] failed to list functions for \" + projectId);\n    logger.debug(\"[functions] \" + err.message);\n    return Promise.reject(err.message);\n  });\n}\n\nfunction _listAllFunctions(projectId) {\n  return _listFunctions(projectId, \"-\");\n}\n\nfunction _checkOperation(operation) {\n  return api.request(\"GET\", \"/\" + API_VERSION + \"/\" + operation.name, {\n    auth: true,\n    origin: api.functionsOrigin\n  }).then(function (resp) {\n    if (resp.body.done) {\n      operation.done = true;\n    }\n\n    if (_.has(resp.body, \"error\")) {\n      operation.error = resp.body.error;\n    }\n\n    return Promise.resolve(operation);\n  }, function (err) {\n    logger.debug(\"[functions] failed to get status of operation: \" + operation.name);\n    logger.debug(\"[functions] \" + err.message);\n    operation.error = err;\n    return Promise.reject(err.message);\n  });\n}\n\nmodule.exports = {\n  DEFAULT_REGION: \"us-central1\",\n  generateUploadUrl: _generateUploadUrl,\n  create: _createFunction,\n  update: _updateFunction,\n  delete: _deleteFunction,\n  list: _listFunctions,\n  listAll: _listAllFunctions,\n  check: _checkOperation,\n  setIamPolicy: _setIamPolicy\n};","map":{"version":3,"sources":["/Users/Erik.Kroha1/Jobs/Verizon/Talk Home/sivr-caller-display/node_modules/firebase-tools/lib/gcp/cloudfunctions.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","_","require","clc","api","FirebaseError","logger","utils","API_VERSION","_functionsOpLogReject","func","type","err","logWarning","bold","yellow","context","response","statusCode","debug","message","info","original","function","_generateUploadUrl","projectId","location","parent","endpoint","request","auth","json","origin","functionsOrigin","retryCodes","responseBody","JSON","parse","body","uploadUrl","_createFunction","options","region","functionName","data","sourceUploadUrl","name","entryPoint","labels","runtime","availableMemoryMb","timeout","assign","trigger","resp","eventType","_setIamPolicy","policy","updateMask","Object","keys","join","_updateFunction","masks","concat","push","eventTrigger","map","subkey","qs","_deleteFunction","_listFunctions","unreachable","length","exit","functionsList","functions","forEach","f","substring","lastIndexOf","_listAllFunctions","_checkOperation","operation","has","error","module","exports","DEFAULT_REGION","generateUploadUrl","create","update","delete","list","listAll","check","setIamPolicy"],"mappings":"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","sourcesContent":["\"use strict\";\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\n    return new (P || (P = Promise))(function (resolve, reject) {\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\n    });\n};\nconst _ = require(\"lodash\");\nconst clc = require(\"cli-color\");\nconst api = require(\"../api\");\nconst { FirebaseError } = require(\"../error\");\nconst logger = require(\"../logger\");\nconst utils = require(\"../utils\");\nconst API_VERSION = \"v1\";\nfunction _functionsOpLogReject(func, type, err) {\n    utils.logWarning(clc.bold.yellow(\"functions:\") + \" failed to \" + type + \" function \" + func);\n    if (err.context.response.statusCode === 429) {\n        logger.debug(err.message);\n        logger.info(\"You have exceeded your deployment quota, please deploy your functions in batches by using the --only flag, \" +\n            \"and wait a few minutes before deploying again. Go to https://firebase.google.com/docs/cli/#partial_deploys to learn more.\");\n    }\n    else {\n        logger.info(err.message);\n    }\n    return Promise.reject(new FirebaseError(`Failed to ${type} function ${func}`, {\n        original: err,\n        context: { function: func },\n    }));\n}\nfunction _generateUploadUrl(projectId, location) {\n    var parent = \"projects/\" + projectId + \"/locations/\" + location;\n    var endpoint = \"/\" + API_VERSION + \"/\" + parent + \"/functions:generateUploadUrl\";\n    return api\n        .request(\"POST\", endpoint, {\n        auth: true,\n        json: false,\n        origin: api.functionsOrigin,\n        retryCodes: [503],\n    })\n        .then(function (result) {\n        var responseBody = JSON.parse(result.body);\n        return Promise.resolve(responseBody.uploadUrl);\n    }, function (err) {\n        logger.info(\"\\n\\nThere was an issue deploying your functions. Verify that your project has a Google App Engine instance setup at https://console.cloud.google.com/appengine and try again. If this issue persists, please contact support.\");\n        return Promise.reject(err);\n    });\n}\nfunction _createFunction(options) {\n    var location = \"projects/\" + options.projectId + \"/locations/\" + options.region;\n    var func = location + \"/functions/\" + options.functionName;\n    var endpoint = \"/\" + API_VERSION + \"/\" + location + \"/functions\";\n    var data = {\n        sourceUploadUrl: options.sourceUploadUrl,\n        name: func,\n        entryPoint: options.entryPoint,\n        labels: options.labels,\n        runtime: options.runtime,\n    };\n    if (options.availableMemoryMb) {\n        data.availableMemoryMb = options.availableMemoryMb;\n    }\n    if (options.timeout) {\n        data.timeout = options.timeout;\n    }\n    return api\n        .request(\"POST\", endpoint, {\n        auth: true,\n        data: _.assign(data, options.trigger),\n        origin: api.functionsOrigin,\n    })\n        .then(function (resp) {\n        return Promise.resolve({\n            func: func,\n            eventType: options.eventType,\n            done: false,\n            name: resp.body.name,\n            type: \"create\",\n        });\n    }, function (err) {\n        return _functionsOpLogReject(options.functionName, \"create\", err);\n    });\n}\nfunction _setIamPolicy(options) {\n    return __awaiter(this, void 0, void 0, function* () {\n        const name = `projects/${options.projectId}/locations/${options.region}/functions/${options.functionName}`;\n        const endpoint = `/${API_VERSION}/${name}:setIamPolicy`;\n        try {\n            yield api.request(\"POST\", endpoint, {\n                auth: true,\n                data: {\n                    policy: options.policy,\n                    updateMask: Object.keys(options.policy).join(\",\"),\n                },\n                origin: api.functionsOrigin,\n            });\n        }\n        catch (err) {\n            throw new FirebaseError(`Failed to set the IAM Policy on the function ${options.functionName}`, { original: err });\n        }\n    });\n}\nfunction _updateFunction(options) {\n    var location = \"projects/\" + options.projectId + \"/locations/\" + options.region;\n    var func = location + \"/functions/\" + options.functionName;\n    var endpoint = \"/\" + API_VERSION + \"/\" + func;\n    var data = _.assign({\n        sourceUploadUrl: options.sourceUploadUrl,\n        name: func,\n        labels: options.labels,\n    }, options.trigger);\n    var masks = [\"sourceUploadUrl\", \"name\", \"labels\"];\n    if (options.runtime) {\n        data.runtime = options.runtime;\n        masks = _.concat(masks, \"runtime\");\n    }\n    if (options.availableMemoryMb) {\n        data.availableMemoryMb = options.availableMemoryMb;\n        masks.push(\"availableMemoryMb\");\n    }\n    if (options.timeout) {\n        data.timeout = options.timeout;\n        masks.push(\"timeout\");\n    }\n    if (options.trigger.eventTrigger) {\n        masks = _.concat(masks, _.map(_.keys(options.trigger.eventTrigger), function (subkey) {\n            return \"eventTrigger.\" + subkey;\n        }));\n    }\n    else {\n        masks = _.concat(masks, \"httpsTrigger\");\n    }\n    return api\n        .request(\"PATCH\", endpoint, {\n        qs: {\n            updateMask: masks.join(\",\"),\n        },\n        auth: true,\n        data: data,\n        origin: api.functionsOrigin,\n    })\n        .then(function (resp) {\n        return Promise.resolve({\n            func: func,\n            done: false,\n            name: resp.body.name,\n            type: \"update\",\n        });\n    }, function (err) {\n        return _functionsOpLogReject(options.functionName, \"update\", err);\n    });\n}\nfunction _deleteFunction(options) {\n    var location = \"projects/\" + options.projectId + \"/locations/\" + options.region;\n    var func = location + \"/functions/\" + options.functionName;\n    var endpoint = \"/\" + API_VERSION + \"/\" + func;\n    return api\n        .request(\"DELETE\", endpoint, {\n        auth: true,\n        origin: api.functionsOrigin,\n    })\n        .then(function (resp) {\n        return Promise.resolve({\n            func: func,\n            done: false,\n            name: resp.body.name,\n            type: \"delete\",\n        });\n    }, function (err) {\n        return _functionsOpLogReject(options.functionName, \"delete\", err);\n    });\n}\nfunction _listFunctions(projectId, region) {\n    var endpoint = \"/\" + API_VERSION + \"/projects/\" + projectId + \"/locations/\" + region + \"/functions\";\n    return api\n        .request(\"GET\", endpoint, {\n        auth: true,\n        origin: api.functionsOrigin,\n    })\n        .then(function (resp) {\n        if (resp.body.unreachable && resp.body.unreachable.length > 0) {\n            return utils.reject(\"Some Cloud Functions regions were unreachable, please try again later.\", { exit: 2 });\n        }\n        var functionsList = resp.body.functions || [];\n        _.forEach(functionsList, function (f) {\n            f.functionName = f.name.substring(f.name.lastIndexOf(\"/\") + 1);\n        });\n        return Promise.resolve(functionsList);\n    }, function (err) {\n        logger.debug(\"[functions] failed to list functions for \" + projectId);\n        logger.debug(\"[functions] \" + err.message);\n        return Promise.reject(err.message);\n    });\n}\nfunction _listAllFunctions(projectId) {\n    return _listFunctions(projectId, \"-\");\n}\nfunction _checkOperation(operation) {\n    return api\n        .request(\"GET\", \"/\" + API_VERSION + \"/\" + operation.name, {\n        auth: true,\n        origin: api.functionsOrigin,\n    })\n        .then(function (resp) {\n        if (resp.body.done) {\n            operation.done = true;\n        }\n        if (_.has(resp.body, \"error\")) {\n            operation.error = resp.body.error;\n        }\n        return Promise.resolve(operation);\n    }, function (err) {\n        logger.debug(\"[functions] failed to get status of operation: \" + operation.name);\n        logger.debug(\"[functions] \" + err.message);\n        operation.error = err;\n        return Promise.reject(err.message);\n    });\n}\nmodule.exports = {\n    DEFAULT_REGION: \"us-central1\",\n    generateUploadUrl: _generateUploadUrl,\n    create: _createFunction,\n    update: _updateFunction,\n    delete: _deleteFunction,\n    list: _listFunctions,\n    listAll: _listAllFunctions,\n    check: _checkOperation,\n    setIamPolicy: _setIamPolicy,\n};\n"]},"metadata":{},"sourceType":"script"}